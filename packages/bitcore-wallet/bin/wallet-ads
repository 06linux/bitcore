#!/usr/bin/env node

var _ = require('lodash');
var program = require('commander');
var utils = require('./cli-utils');
program = utils.configureCommander(program);

program
  .option('-a, --active', 'Makes ad active', true)
  .usage('[options] <name> <title> <country> <body> <imgUrl> <linkText> <linkUrl> <app>')
  .parse(process.argv);

// Pseudo code
// message, m
// JSON.stringify (
//  {
//    id,
//    name,
//    title,
//    country,
//    body, 
//    imgUrl,
//    linkTest,
//    linkUrl,
//    app
//  }

// Sign (m, privkey)
// Verify(signature, m, publicKey)

var args = program.args;
var host = 'http://localhost:3232/bws/api/';

var clientArgs = {
  host
}

var name = args[0];
var title = args[1];
var country = args[2]
var body = args[3];
var imgUrl = args[4];
var linkText = args[5];
var linkUrl = args[6];
var app = args[7];

var requiredArgs = {
  name,
  title,
  country,
  body,
  imgUrl,
  linkText,
  linkUrl,
  app
}

let missingArgs = [];
_.forEach(requiredArgs, (value, requiredArg) => {
  if (value === undefined) {
    missingArgs.push(requiredArg);
  }
});

if (!_.isEmpty(missingArgs)) {
  _.forEach(missingArgs, (arg) => {
    console.log(arg + ' is missing. Please run again with correct arguments.')
  });

  throw new Error("Missing required arguments");
}

var dismissible = true;
var isAdActive = program.active ? program.active : false;
var isTesting = !isAdActive;

let adArgs = {
  dismissible,
  isAdActive,
  isTesting,
  type: 'standard',
  ...requiredArgs
};

utils.getClient(clientArgs, { 
  mustExist: true, 
  walletId: 'f48d485b-66f8-40d0-9db2-24fa0f707ea6'
}, function (client) {
  client.createAdvertisement(adArgs, (err, result) => {
    utils.die(err);
    if(!result) {
      console.log('Couldn\'t create advertisement');
    }
    else {
      console.log('Succesfully Created advertisement ', result);
    }
  });
});